<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Education Portal</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap");

        body {
            font-family: "Inter", sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(
                to bottom right,
                #e0f2fe,
                #e9d5ff
            ); /* Light blue to light purple gradient */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            padding: 2.5rem 1.5rem; /* Equivalent to p-6 */
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 48rem; /* Equivalent to max-w-3xl */
            background-color: rgba(255, 255, 255, 0.8); /* bg-white/80 */
            backdrop-filter: blur(8px); /* backdrop-blur */
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
            0 8px 10px -6px rgba(0, 0, 0, 0.1); /* shadow-2xl */
            padding: 2rem; /* p-8 */
            margin-top: 2rem; /* mt-8 */
        }

        h1 {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 800; /* font-extrabold */
            color: #4338ca; /* text-indigo-800 */
            margin-bottom: 0.5rem; /* mb-2 */
            text-align: center;
            letter-spacing: -0.025em; /* tracking-tight */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); /* drop-shadow */
        }

        .subtitle {
            margin-top: 0.5rem; /* mt-2 */
            margin-bottom: 1.5rem; /* mb-6 */
            text-align: center;
            font-size: 1.125rem; /* text-lg */
            color: #4b5563; /* text-gray-700 */
        }

        /* Tabs Outer */
        .tabs-container {
            width: 100%;
        }

        .tabs-list {
            display: flex;
            justify-content: center;
            gap: 1rem; /* gap-4 */
            margin-bottom: 1.5rem; /* mb-6 */
            background-color: #eef2ff; /* bg-indigo-50 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 0.5rem; /* p-2 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
            0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
        }

        .tab-trigger {
            padding: 0.5rem 1.5rem; /* px-6 py-2 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            color: #4f46e5; /* text-indigo-700 */
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* transition */
            border: none;
            background: none;
        }

        .tab-trigger.active {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
        }

        .tab-content {
            border-radius: 1rem; /* rounded-2xl */
            padding: 1rem; /* p-4 */
            background-color: #eef2ff; /* bg-indigo-50 */
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* shadow-inner */
        }

        /* Inner Tabs */
        .inner-tabs-list {
            display: flex;
            justify-content: center;
            gap: 0.5rem; /* gap-2 */
            margin-bottom: 1rem; /* mb-4 */
            background-color: white;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
            0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            padding: 0.25rem;
        }

        .inner-tab-trigger {
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-radius: 0.25rem; /* rounded */
            font-weight: 500; /* font-medium */
            color: #4f46e5; /* text-indigo-700 */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            background: none;
        }

        .inner-tab-trigger.active {
            background-color: #6366f1; /* bg-indigo-500 */
            color: white;
        }

        /* My Courses Grid */
        .course-grid {
            display: grid;
            grid-template-columns: 1fr; /* grid-cols-1 */
            gap: 1.5rem; /* gap-6 */
        }

        @media (min-width: 640px) {
            /* sm breakpoint */
            .course-grid {
                grid-template-columns: repeat(2, 1fr); /* sm:grid-cols-2 */
            }
        }

        .course-card {
            padding: 1.25rem; /* p-5 */
            border: 1px solid #e0e7ff; /* border border-indigo-100 */
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-md */
            background-color: white;
            transition: all 0.2s ease-in-out;
        }

        .course-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
            0 4px 6px -4px rgba(0, 0, 0, 0.1); /* hover:shadow-xl */
        }

        .course-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #4f46e5; /* text-indigo-700 */
            margin-bottom: 0.25rem; /* mb-1 */
        }

        .course-description {
            color: #4b5563; /* text-gray-600 */
            font-size: 0.875rem; /* text-sm */
        }

        /* Upcoming Events */
        .events-section {
            padding: 1rem; /* p-4 */
            background-color: white;
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow */
            margin-bottom: 1rem; /* space-y-4 for content inside */
        }

        .events-section h3 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            color: #4f46e5; /* text-indigo-700 */
            border-bottom: 1px solid #e5e7eb; /* border-b */
            padding-bottom: 0.5rem; /* pb-2 */
            margin-bottom: 1rem;
        }

        .event-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem; /* gap-4 */
            margin-bottom: 1rem; /* space-y-4 on ul */
        }

        .event-bullet {
            margin-top: 0.25rem; /* mt-1 */
            width: 0.75rem; /* w-3 */
            height: 0.75rem; /* h-3 */
            background-color: #6366f1; /* bg-indigo-500 */
            border-radius: 9999px; /* rounded-full */
            flex-shrink: 0;
        }

        .event-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 500; /* font-medium */
            color: #374151; /* text-gray-800 */
        }

        .event-date {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
        }

        /* Discussion Forum */
        .forum-container {
            max-width: 32rem; /* max-w-lg */
            margin-left: auto;
            margin-right: auto;
            padding: 1rem; /* p-4 */
            background-color: white;
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow */
            display: flex;
            flex-direction: column;
            height: 400px;
        }

        .messages-display {
            flex: 1; /* flex-1 */
            overflow-y: auto;
            margin-bottom: 1rem; /* mb-4 */
            padding-right: 0.5rem; /* px-2 */
            padding-left: 0.5rem; /* px-2 */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #a78bfa transparent; /* Firefox */
        }

        .messages-display::-webkit-scrollbar {
            width: 8px;
        }

        .messages-display::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-display::-webkit-scrollbar-thumb {
            background-color: #a78bfa;
            border-radius: 4px;
            border: 2px solid transparent;
        }

        .message-bubble {
            background-color: #e0e7ff; /* bg-indigo-100 */
            color: #312e81; /* text-indigo-900 */
            padding: 0.5rem; /* p-2 */
            border-radius: 0.375rem; /* rounded-md */
            width: fit-content; /* w-fit */
            max-width: 80%; /* max-w-[80%] */
            margin-bottom: 0.5rem; /* space-y-2 */
        }

        .message-input-area {
            display: flex;
            gap: 0.5rem; /* gap-2 */
        }

        .message-input {
            flex: 1; /* flex-1 */
            border: 1px solid #c7d2fe; /* border border-indigo-200 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            outline: none;
        }

        .message-input:focus {
            ring-width: 2px; /* focus:ring-2 */
            ring-color: #818cf8; /* focus:ring-indigo-400 */
            border-color: #818cf8;
        }

        .post-button {
            background-color: #6366f1; /* bg-indigo-500 */
            color: white;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
            0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none;
        }

        .post-button:hover {
            background-color: #4f46e5; /* hover:bg-indigo-600 */
        }

        /* Admin Access / Login */
        .admin-login-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* gap-3 */
            background-color: white;
            padding: 1.5rem; /* p-6 */
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow */
            width: 100%;
            max-width: 28rem; /* max-w-md */
            margin-left: auto;
            margin-right: auto;
        }

        .admin-login-container p {
            color: #4b5563; /* text-gray-700 */
            text-align: center;
            font-size: 1.125rem; /* text-lg */
            font-weight: 500; /* font-medium */
        }

        .admin-code-input {
            padding: 0.5rem; /* p-2 */
            border: 1px solid #c7d2fe; /* border border-indigo-200 */
            border-radius: 0.375rem; /* rounded-md */
            outline: none;
        }

        .admin-code-input:focus {
            ring-width: 2px; /* focus:ring-2 */
            ring-color: #818cf8; /* focus:ring-indigo-400 */
            border-color: #818cf8;
        }

        .admin-submit-button {
            background-color: #6366f1; /* bg-indigo-500 */
            color: white;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem; /* py-2 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
            0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none;
        }

        .admin-submit-button:hover {
            background-color: #4f46e5; /* hover:bg-indigo-600 */
        }

        /* Admin Management Tabs */
        .admin-management-section {
            padding: 1rem;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .admin-management-section h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #4f46e5; /* text-indigo-700 */
            margin-bottom: 1rem;
        }

        .admin-course-item,
        .admin-event-item {
            padding: 0.75rem; /* p-3 */
            border: 1px solid #e5e7eb; /* border */
            border-radius: 0.375rem; /* rounded-md */
            background-color: #f9fafb; /* bg-gray-50 */
            margin-bottom: 0.75rem; /* space-y-1 on parent, so margin-bottom for children */
        }

        .admin-course-item:last-child,
        .admin-event-item:last-child {
            margin-bottom: 0;
        }

        .admin-course-item input,
        .admin-course-item textarea,
        .admin-event-item input,
        .admin-event-item textarea {
            width: 100%;
            padding: 0.5rem; /* p-2 */
            border: 1px solid #c7d2fe; /* border border-indigo-200 */
            border-radius: 0.375rem; /* rounded-md */
            outline: none;
            margin-bottom: 0.5rem; /* space between input/textarea */
        }

        .admin-course-item textarea,
        .admin-event-item textarea {
            resize: vertical;
            min-height: 40px;
        }

        .admin-user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb; /* border-b */
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
        }

        .admin-user-item:last-child {
            border-bottom: none;
        }

        .user-name {
            font-weight: 500; /* font-medium */
            color: #374151; /* text-gray-800 */
        }

        .user-role {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
        }

        .user-role span {
            font-weight: 600; /* font-semibold */
        }

        .toggle-role-button,
        .delete-btn,
        .update-btn,
        .add-btn {
            font-size: 0.875rem; /* text-sm */
            background-color: #6366f1; /* bg-indigo-500 */
            color: white;
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
            0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none;
        }

        .toggle-role-button:hover,
        .delete-btn:hover,
        .update-btn:hover,
        .add-btn:hover {
            background-color: #4f46e5; /* hover:bg-indigo-600 */
        }

        .delete-btn {
            background-color: #ef4444; /* red-500 */
        }

        .delete-btn:hover {
            background-color: #dc2626; /* red-600 */
        }

        .add-btn {
            background-color: #22c55e; /* green-500 */
        }

        .add-btn:hover {
            background-color: #16a34a; /* green-600 */
        }

        .settings-section label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* text-gray-700 */
            margin-bottom: 0.25rem;
        }

        .settings-section input[type="password"] {
            width: 100%;
            padding: 0.5rem; /* p-2 */
            border: 1px solid #c7d2fe; /* border border-indigo-200 */
            border-radius: 0.375rem; /* rounded-md */
            outline: none;
        }

        .change-password-button {
            margin-top: 0.5rem; /* mt-2 */
            background-color: #6366f1; /* bg-indigo-500 */
            color: white;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
            0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none;
        }

        .change-password-button:hover {
            background-color: #4f46e5; /* hover:bg-indigo-600 */
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Education Portal</h1>
    <p class="subtitle">
        Empower yourself with knowledge and skills. Choose your role to get
        started!
    </p>

    <div class="tabs-container">
        <div class="tabs-list">
            <button class="tab-trigger active" onclick="showTab('Student')">
                Student
            </button>
            <button class="tab-trigger" onclick="showTab('Admin')">Admin</button>
        </div>

        <div id="Student" class="tab-content">
            <div class="inner-tabs-list">
                <button
                    class="inner-tab-trigger active"
                    onclick="showInnerTab('My Courses')">
                    My Courses
                </button>
                <button
                    class="inner-tab-trigger"
                    onclick="showInnerTab('Upcoming Events')">
                    Upcoming Events
                </button>
                <button
                    class="inner-tab-trigger"
                    onclick="showInnerTab('Discussion Forum')">
                    Discussion Forum
                </button>
            </div>

            <div id="My Courses" class="course-grid">
                </div>

            <div
                id="Upcoming Events"
                class="events-section"
                style="display: none">
                <h3>Upcoming Medical Events</h3>
                <ul class="space-y-4" id="eventsList">
                    </ul>
            </div>

            <div
                id="Discussion Forum"
                class="forum-container"
                style="display: none">
                <div class="messages-display" id="messagesDisplay">
                    </div>
                <div class="message-input-area">
                    <input
                        type="text"
                        class="message-input"
                        placeholder="Type a message..."
                        id="messageInput" />
                    <button class="post-button" id="postMessageButton">Post</button>
                </div>
            </div>
        </div>

        <div id="Admin" class="tab-content" style="display: none">
            <div id="adminManagement">
                <div class="inner-tabs-list">
                    <button
                        class="inner-tab-trigger active"
                        onclick="showAdminInnerTab('course-management')">
                        Manage Courses
                    </button>
                    <button
                        class="inner-tab-trigger"
                        onclick="showAdminInnerTab('event-management')">
                        Manage Events
                    </button>
                    <button
                        class="inner-tab-trigger"
                        onclick="showAdminInnerTab('user-roles')">
                        User Roles
                    </button>
                    <button
                        class="inner-tab-trigger"
                        onclick="showAdminInnerTab('settings')">
                        Settings
                    </button>
                </div>

                <div id="course-management" class="admin-management-section">
                    <h3>Edit Courses</h3>
                    <div id="adminCourseList">
                        </div>
                    <div style="margin-top: 1rem;">
                        <input type="text" id="newCourseTitle" placeholder="New Course Title" class="admin-course-item-input" />
                        <textarea id="newCourseDescription" placeholder="New Course Description" class="admin-course-item-textarea"></textarea>
                        <button class="add-btn" onclick="addCourse()">Add Course</button>
                    </div>
                </div>

                <div id="event-management" class="admin-management-section" style="display: none;">
                    <h3>Edit Events</h3>
                    <div id="adminEventList">
                        </div>
                    <div style="margin-top: 1rem;">
                        <input type="text" id="newEventTitle" placeholder="New Event Title" class="admin-event-item-input" />
                        <input type="date" id="newEventDate" class="admin-event-item-input" />
                        <button class="add-btn" onclick="addEvent()">Add Event</button>
                    </div>
                </div>

                <div
                    id="user-roles"
                    class="admin-management-section"
                    style="display: none">
                    <h3>User Roles</h3>
                    <p class="text-gray-700 text-sm">
                        Assign or revoke admin access for users.
                    </p>
                    <div id="userRolesList">
                        </div>
                </div>

                <div
                    id="settings"
                    class="admin-management-section"
                    style="display: none">
                    <h3>Account Settings</h3>
                    <label>New Admin Access Code</label>
                    <input type="password" id="newAdminCode" placeholder="Enter new admin code" />
                    <button class="change-password-button" onclick="updateAdminCode()">Change Admin Code</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = "/api/education"; // Adjust if your server runs on a different port

    

    // --- Utility Functions ---
    async function fetchData(url) {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
    }

    async function postData(url, data) {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
    }

    async function putData(url, data) {
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
    }

    async function deleteData(url) {
        const response = await fetch(url, {
            method: 'DELETE',
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return true;
    }

    // --- Render Functions (Student View) ---
    async function renderCourses() {
        const courseGrid = document.getElementById('My Courses');
        courseGrid.innerHTML = 'Loading courses...';
        try {
            const courses = await fetchData(`${API_BASE_URL}/courses`);
            courseGrid.innerHTML = '';
            if (courses.length === 0) {
                courseGrid.innerHTML = '<p class="text-gray-600 text-center col-span-full">No courses available.</p>';
                return;
            }
            courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.innerHTML = `
                    <h3 class="course-title">${course.title}</h3>
                    <p class="course-description">${course.description}</p>
                `;
                courseGrid.appendChild(card);
            });
        } catch (error) {
            console.error("Error fetching courses:", error);
            courseGrid.innerHTML = '<p class="text-red-500 text-center col-span-full">Failed to load courses.</p>';
        }
    }

    async function renderEvents() {
        const eventsList = document.getElementById('eventsList');
        eventsList.innerHTML = 'Loading events...';
        try {
            const events = await fetchData(`${API_BASE_URL}/events`);
            eventsList.innerHTML = '';
            if (events.length === 0) {
                eventsList.innerHTML = '<p class="text-gray-600 text-center">No upcoming events.</p>';
                return;
            }
            events.forEach(event => {
                const li = document.createElement('li');
                li.className = 'event-item';
                li.innerHTML = `
                    <div class="event-bullet"></div>
                    <div>
                        <p class="event-title">${event.title}</p>
                        <p class="event-date">📅 ${new Date(event.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                `;
                eventsList.appendChild(li);
            });
        } catch (error) {
            console.error("Error fetching events:", error);
            eventsList.innerHTML = '<p class="text-red-500 text-center">Failed to load events.</p>';
        }
    }

    async function renderMessages() {
        const messagesDisplay = document.getElementById('messagesDisplay');
        messagesDisplay.innerHTML = 'Loading messages...';
        try {
            const messages = await fetchData(`${API_BASE_URL}/messages`);
            messagesDisplay.innerHTML = '';
            if (messages.length === 0) {
                messagesDisplay.innerHTML = '<p class="text-gray-600 text-center">No messages yet. Be the first to post!</p>';
                return;
            }
            messages.forEach(message => {
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.innerHTML = `
                    ${message.content}
                    ${adminLoggedIn ? `<button class="delete-btn" style="margin-left: 0.5rem; padding: 0.1rem 0.3rem;" onclick="deleteMessage('${message._id}')">x</button>` : ''}
                `;
                messagesDisplay.appendChild(bubble);
            });
            messagesDisplay.scrollTop = messagesDisplay.scrollHeight; // Scroll to bottom
        } catch (error) {
            console.error("Error fetching messages:", error);
            messagesDisplay.innerHTML = '<p class="text-red-500 text-center">Failed to load messages.</p>';
        }
    }

    async function postMessage() {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();
        if (content) {
            try {
                await postData(`${API_BASE_URL}/messages`, { content });
                messageInput.value = '';
                await renderMessages();
            } catch (error) {
                console.error("Error posting message:", error);
                alert("Failed to post message.");
            }
        }
    }

    async function deleteMessage(id) {
        if (!confirm("Are you sure you want to delete this message?")) return;
        try {
            await deleteData(`${API_BASE_URL}/messages/${id}`);
            await renderMessages();
        } catch (error) {
            console.error("Error deleting message:", error);
            alert("Failed to delete message.");
        }
    }

    // --- Render Functions (Admin View) ---
    async function renderAdminCourses() {
        const adminCourseList = document.getElementById('adminCourseList');
        adminCourseList.innerHTML = 'Loading courses...';
        try {
            const courses = await fetchData(`${API_BASE_URL}/courses`);
            adminCourseList.innerHTML = '';
            if (courses.length === 0) {
                adminCourseList.innerHTML = '<p class="text-gray-600">No courses to manage.</p>';
                return;
            }
            courses.forEach(course => {
                const item = document.createElement('div');
                item.className = 'admin-course-item';
                item.dataset.id = course._id;
                item.innerHTML = `
                    <input type="text" value="${course.title}" onchange="updateCourse('${course._id}', 'title', this.value)" />
                    <textarea onchange="updateCourse('${course._id}', 'description', this.value)">${course.description}</textarea>
                    <button class="delete-btn" onclick="deleteCourse('${course._id}')">Delete</button>
                `;
                adminCourseList.appendChild(item);
            });
        } catch (error) {
            console.error("Error fetching admin courses:", error);
            adminCourseList.innerHTML = '<p class="text-red-500">Failed to load courses for management.</p>';
        }
    }

    async function addCourse() {
        const newCourseTitle = document.getElementById('newCourseTitle').value.trim();
        const newCourseDescription = document.getElementById('newCourseDescription').value.trim();
        if (newCourseTitle && newCourseDescription) {
            try {
                await postData(`${API_BASE_URL}/courses`, { title: newCourseTitle, description: newCourseDescription });
                document.getElementById('newCourseTitle').value = '';
                document.getElementById('newCourseDescription').value = '';
                await renderAdminCourses();
                await renderCourses(); // Refresh student view
            } catch (error) {
                console.error("Error adding course:", error);
                alert("Failed to add course.");
            }
        } else {
            alert("Please enter both title and description for the new course.");
        }
    }

    async function updateCourse(id, field, value) {
        try {
            const updates = {};
            updates[field] = value;
            await putData(`${API_BASE_URL}/courses/${id}`, updates);
            // No need to re-render admin courses immediately, as the input value already reflects change
            await renderCourses(); // Refresh student view
        } catch (error) {
            console.error(`Error updating course ${field}:`, error);
            alert(`Failed to update course ${field}.`);
        }
    }

    async function deleteCourse(id) {
        if (!confirm("Are you sure you want to delete this course?")) return;
        try {
            await deleteData(`${API_BASE_URL}/courses/${id}`);
            await renderAdminCourses();
            await renderCourses(); // Refresh student view
        } catch (error) {
            console.error("Error deleting course:", error);
            alert("Failed to delete course.");
        }
    }

    async function renderAdminEvents() {
        const adminEventList = document.getElementById('adminEventList');
        adminEventList.innerHTML = 'Loading events...';
        try {
            const events = await fetchData(`${API_BASE_URL}/events`);
            adminEventList.innerHTML = '';
            if (events.length === 0) {
                adminEventList.innerHTML = '<p class="text-gray-600">No events to manage.</p>';
                return;
            }
            events.forEach(event => {
                const item = document.createElement('div');
                item.className = 'admin-event-item';
                item.dataset.id = event._id;
                // Format date for input type="date"
                const eventDate = new Date(event.date).toISOString().split('T')[0];
                item.innerHTML = `
                    <input type="text" value="${event.title}" onchange="updateEvent('${event._id}', 'title', this.value)" />
                    <input type="date" value="${eventDate}" onchange="updateEvent('${event._id}', 'date', this.value)" />
                    <button class="delete-btn" onclick="deleteEvent('${event._id}')">Delete</button>
                `;
                adminEventList.appendChild(item);
            });
        } catch (error) {
            console.error("Error fetching admin events:", error);
            adminEventList.innerHTML = '<p class="text-red-500">Failed to load events for management.</p>';
        }
    }

    async function addEvent() {
        const newEventTitle = document.getElementById('newEventTitle').value.trim();
        const newEventDate = document.getElementById('newEventDate').value;
        if (newEventTitle && newEventDate) {
            try {
                await postData(`${API_BASE_URL}/events`, { title: newEventTitle, date: newEventDate });
                document.getElementById('newEventTitle').value = '';
                document.getElementById('newEventDate').value = '';
                await renderAdminEvents();
                await renderEvents(); // Refresh student view
            } catch (error) {
                console.error("Error adding event:", error);
                alert("Failed to add event.");
            }
        } else {
            alert("Please enter both title and date for the new event.");
        }
    }

    async function updateEvent(id, field, value) {
        try {
            const updates = {};
            updates[field] = value;
            await putData(`${API_BASE_URL}/events/${id}`, updates);
            await renderEvents(); // Refresh student view
        } catch (error) {
            console.error(`Error updating event ${field}:`, error);
            alert(`Failed to update event ${field}.`);
        }
    }

    async function deleteEvent(id) {
        if (!confirm("Are you sure you want to delete this event?")) return;
        try {
            await deleteData(`${API_BASE_URL}/events/${id}`);
            await renderAdminEvents();
            await renderEvents(); // Refresh student view
        } catch (error) {
            console.error("Error deleting event:", error);
            alert("Failed to delete event.");
        }
    }

    async function renderUserRoles() {
        const userRolesList = document.getElementById('userRolesList');
        userRolesList.innerHTML = 'Loading users...';
        try {
            const users = await fetchData(`/api/user/all`);
            userRolesList.innerHTML = '';
            if (users.length === 0) {
                userRolesList.innerHTML = '<p class="text-gray-600">No users found.</p>';
                return;
            }
            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'admin-user-item';
                item.innerHTML = `
                    <div>
                        <p class="user-name">${user.name}</p>
                        <p class="user-role">Role: <span class="font-semibold">${user.role}</span></p>
                    </div>
                    <button class="toggle-role-button" onclick="toggleUserRole('${user.name}', '${user.role}')">
                        ${user.role === 'Admin' ? 'Make Student' : 'Make Admin'}
                    </button>
                `;
                userRolesList.appendChild(item);
            });
        } catch (error) {
            console.error("Error fetching user roles:", error);
            userRolesList.innerHTML = '<p class="text-red-500">Failed to load user roles.</p>';
        }
    }

    async function toggleUserRole(name, currentRole) {
        const newRole = currentRole === 'Admin' ? 'Student' : 'Admin';
        try {
            await putData(`/api/user/${name}`, { role: newRole });
            await renderUserRoles(); // Refresh user list
        } catch (error) {
            console.error("Error toggling user role:", error);
            alert("Failed to toggle user role.");
        }
    }

    async function updateAdminCode() {
        const newCode = document.getElementById('newAdminCode').value.trim();
        if (newCode) {
            // In a real application, you'd send this to the backend
            // for secure hashing and storage. For this example, we'll
            // just update the frontend variable.
            currentAdminCode = newCode;
            document.getElementById('newAdminCode').value = '';
            alert("Admin access code updated successfully (frontend only).");
        } else {
            alert("Please enter a new admin code.");
        }
    }


    // --- Tab Switching Logic ---
    // Admin access will be determined by backend API calls.

    function showTab(tabName) {
        var i, tabcontent, tabtriggers;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tabtriggers = document.getElementsByClassName("tab-trigger");
        for (i = 0; i < tabtriggers.length; i++) {
            tabtriggers[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        event.currentTarget.classList.add("active");

        // Reset inner tabs and load data when main tab changes
        if (tabName === "Student") {
            showInnerTab("My Courses"); // Default to My Courses
            renderCourses();
            renderEvents();
            renderMessages();
        } else if (tabName === "Admin") {
            try {
                // Attempt to fetch users to check admin access
                await fetchData('/api/user/all');
                document.getElementById("adminManagement").style.display = "block";
                showAdminInnerTab("course-management"); // Default to course management
                renderAdminCourses();
                renderAdminEvents();
                renderUserRoles();
            } catch (error) {
                console.error("Admin access check failed:", error);
                alert("Access Denied. You must be an Admin to access this section.");
                // Redirect back to student tab if not authorized
                showTab('Student');
            }
        }
    }

    function showInnerTab(innerTabName) {
        var i, innerTabContent, innerTabTriggers;
        innerTabContent = document.querySelectorAll(
            "#Student .tab-content > div:not(.inner-tabs-list)"
        );
        for (i = 0; i < innerTabContent.length; i++) {
            innerTabContent[i].style.display = "none";
        }
        innerTabTriggers = document.querySelectorAll(
            "#Student .inner-tab-trigger"
        );
        for (i = 0; i < innerTabTriggers.length; i++) {
            innerTabTriggers[i].classList.remove("active");
        }
        document.getElementById(innerTabName).style.display = "block";
        event.currentTarget.classList.add("active");

        // Reload data for the specific inner tab if needed
        if (innerTabName === 'My Courses') {
            renderCourses();
        } else if (innerTabName === 'Upcoming Events') {
            renderEvents();
        } else if (innerTabName === 'Discussion Forum') {
            renderMessages();
        }
    }

    function showAdminInnerTab(innerTabName) {
        var i, adminInnerTabContent, adminInnerTabTriggers;
        adminInnerTabContent = document.querySelectorAll(
            "#Admin .admin-management-section" // Target sections directly
        );
        for (i = 0; i < adminInnerTabContent.length; i++) {
            adminInnerTabContent[i].style.display = "none";
        }
        adminInnerTabTriggers = document.querySelectorAll(
            "#Admin .inner-tab-trigger"
        );
        for (i = 0; i < adminInnerTabTriggers.length; i++) {
            adminInnerTabTriggers[i].classList.remove("active");
        }
        document.getElementById(innerTabName).style.display = "block";
        event.currentTarget.classList.add("active");

        // Reload data for the specific admin inner tab
        if (innerTabName === 'course-management') {
            renderAdminCourses();
        } else if (innerTabName === 'event-management') {
            renderAdminEvents();
        } else if (innerTabName === 'user-roles') {
            renderUserRoles();
        }
    }

    

    // Event listener for posting messages
    document.getElementById('postMessageButton').addEventListener('click', postMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            postMessage();
        }
    });

    // Initial load: show Student tab and My Courses sub-tab
    document.addEventListener("DOMContentLoaded", () => {
        showTab("Student"); // This will also trigger the initial data fetches for the student view
    });
</script>
</body>
</html>