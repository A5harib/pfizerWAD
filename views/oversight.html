<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clinical Study Oversight</title>
    <!-- Font Awesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Google Font - Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet" />
    <style>
      /* Base Styles */
      body {
        margin: 0;
        font-family: "Inter", sans-serif;
        background: linear-gradient(to bottom right, #e0f2fe, #e9d5ff);
        color: #111827;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 2rem 1rem;
        box-sizing: border-box;
      }

      .container {
        width: 100%;
        max-width: 1200px;
        margin: auto;
      }

      /* Card Styles */
      .card {
        background: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        padding: 2rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
      }

      .card-header {
        padding-bottom: 1rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
      }

      .card-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .card-description {
        color: #6b7280;
        font-size: 0.9375rem;
        margin-top: 0.5rem;
      }

      /* Buttons */
      .btn {
        cursor: pointer;
        font-weight: 600;
        padding: 0.6rem 1rem;
        border-radius: 0.375rem;
        border: none;
        transition: background 0.3s ease, transform 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        white-space: nowrap;
      }

      .btn-primary {
        background: #6366f1;
        color: #fff;
        box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3);
      }

      .btn-primary:hover {
        background: #4f46e5;
        transform: translateY(-1px);
      }

      .btn-outline {
        background: #fff;
        color: #4f46e5;
        border: 1px solid #c7d2fe;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .btn-outline:hover {
        background: #eef2ff;
        color: #4338ca;
        transform: translateY(-1px);
      }

      .btn-destructive {
        background: #ef4444;
        color: #fff;
        box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3);
      }

      .btn-destructive:hover {
        background: #dc2626;
        transform: translateY(-1px);
      }

      .btn-success {
        background: #22c55e;
        color: #fff;
        box-shadow: 0 2px 5px rgba(34, 197, 94, 0.3);
      }

      .btn-success:hover {
        background: #16a34a;
        transform: translateY(-1px);
      }

      .btn-sm {
        padding: 0.3rem 0.6rem;
        font-size: 0.875rem;
        min-width: 2rem;
        min-height: 2rem;
        padding: 0;
      }
      .btn-sm i {
        font-size: 0.875rem;
      }

      /* Tabs */
      .tab-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        background: #eef2ff;
        border-radius: 0.75rem;
        padding: 0.5rem;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .tab-buttons button {
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        background: transparent;
        color: #4f46e5;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .tab-buttons button.active {
        background: #6366f1;
        color: #fff;
        box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3);
      }

      .tab-buttons button:hover:not(.active) {
        background: #e0e7ff;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Form Elements */
      .form-group {
        margin-bottom: 1rem;
      }

      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #374151;
        font-size: 0.9375rem;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        box-sizing: border-box;
        font-size: 1rem;
        color: #374151;
        transition: border-color 0.3s, box-shadow 0.3s;
        background-color: #fff;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
      }

      .form-group textarea {
        min-height: 5rem;
        resize: vertical;
      }

      /* Search Input with Icon */
      .input-with-icon {
        position: relative;
        margin-bottom: 1rem;
      }
      .input-with-icon input {
        padding-left: 2.5rem;
      }
      .input-with-icon i {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 1rem;
      }

      /* Tables */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1.5rem;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      thead {
        background: #f3f4f6;
      }

      th,
      td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        font-size: 0.875rem;
        color: #374151;
      }

      th {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      tbody tr:nth-child(even) {
        background-color: #f9fafb;
      }

      tbody tr:hover {
        background-color: #f0f4f8;
      }

      .actions-cell {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
      }

      /* Status Badges */
      .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
      }

      .status-green {
        background-color: #dcfce7;
        color: #16a34a;
      }
      .status-yellow {
        background-color: #fef9c3;
        color: #b45309;
      }
      .status-red {
        background-color: #fee2e2;
        color: #dc2626;
      }
      .status-blue {
        background-color: #dbeafe;
        color: #2563eb;
      }
      .status-gray {
        background-color: #f3f4f6;
        color: #4b5563;
      }
      .status-orange {
        background-color: #ffedd5;
        color: #f97316;
      }

      /* Audit Log */
      .audit-log-container {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem;
        max-height: 12rem;
        overflow-y: auto;
        background-color: #f9fafb;
        font-size: 0.875rem;
        line-height: 1.4;
      }

      .audit-log-entry {
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f3f4f6;
      }
      .audit-log-entry:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .audit-log-entry .timestamp {
        font-weight: 500;
        color: #4b5563;
      }
      .audit-log-entry .type {
        font-weight: 600;
        color: #1f2937;
        text-transform: capitalize;
      }

      /* Modals (Dialogs) */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        box-sizing: border-box;
      }

      .modal-content {
        background-color: #fefefe;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        width: 100%;
        max-width: 500px;
        position: relative;
        animation: fadeInScale 0.3s ease-out;
      }

      @keyframes fadeInScale {
        from {
          opacity: 0;
          transform: scale(0.95) translateY(20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-close-btn {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: #9ca3af;
        cursor: pointer;
        transition: color 0.2s ease;
        background: none;
        border: none;
        padding: 0;
      }

      .modal-close-btn:hover {
        color: #6b7280;
      }

      .modal-header {
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
      }

      .modal-description {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }

      .modal-body {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding-top: 0.5rem;
      }

      .modal-footer {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
      }

      /* Toast Notification */
      #custom-toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #333;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 1rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        z-index: 1002;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }
        .tab-buttons {
          grid-template-columns: 1fr;
        }
        .card {
          padding: 1.5rem;
        }
        th,
        td {
          padding: 0.75rem 1rem;
        }
        .actions-cell {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.25rem;
        }
        .btn-sm {
          width: 100%;
        }
        .input-group {
          flex-direction: column;
          align-items: stretch;
        }
        .input-group > div {
          width: 100%;
        }
      }

      /* Specific styles for Regulatory Tab input groups */
      .input-group {
        display: flex;
        align-items: flex-end;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .input-group > div {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      .input-group button {
        flex-shrink: 0;
      }

      .text-gray-500 {
        color: #6b7280;
      }
      .italic {
        font-style: italic;
      }
      .text-center {
        text-align: center;
      }
      .font-semibold {
        font-weight: 600;
      }
      .mb-2 {
        margin-bottom: 0.5rem;
      }
      .mb-3 {
        margin-bottom: 0.75rem;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .mt-4 {
        margin-top: 1rem;
      }
      .mt-6 {
        margin-top: 1.5rem;
      }
      .space-y-2 > *:not(:first-child) {
        margin-top: 0.5rem;
      }
      .space-y-3 > *:not(:first-child) {
        margin-top: 0.75rem;
      }
      .space-y-4 > *:not(:first-child) {
        margin-top: 1rem;
      }
      .space-y-6 > *:not(:first-child) {
        margin-top: 1.5rem;
      }
      .flex-1 {
        flex: 1;
      }
      .flex {
        display: flex;
      }
      .items-center {
        align-items: center;
      }
      .justify-between {
        justify-content: space-between;
      }
      .justify-end {
        justify-content: flex-end;
      }
      .capitalize {
        text-transform: capitalize;
      }
      .line-through {
        text-decoration: line-through;
      }
      .hidden {
        display: none !important;
      }
      .whitespace-nowrap {
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Login Container -->
      <div id="login-container" class="card admin-access-container">
        <p class="text-lg font-medium mb-4 text-center text-gray-700">
          Enter admin access code to proceed:
        </p>
        <div class="form-group">
          <input
            type="password"
            id="admin-code-input"
            placeholder="Admin code" />
        </div>
        <button class="btn btn-primary w-full" id="login-button">
          <i class="fas fa-unlock mr-2"></i> Submit
        </button>
      </div>

      <!-- Main Application Container (Hidden by default) -->
      <div id="app-container" class="hidden">
        <div class="text-center mb-8">
          <h1 class="card-title justify-center text-3xl font-bold">
            Clinical Study Oversight
          </h1>
          <p class="card-description">
            Manage data from Clinical Managers, CRAs, and Regulatory Affairs.
          </p>
        </div>

        <div class="tab-buttons">
          <button id="tab-clinical" class="active" data-tab="clinical">
            Clinical Manager
          </button>
          <button id="tab-cra" data-tab="cra">CRA</button>
          <button id="tab-regulatory" data-tab="regulatory">
            Regulatory Affairs
          </button>
        </div>

        <!-- Clinical Manager Tab Content -->
        <div id="clinical" class="tab-content active card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-file-medical mr-2"></i> Site Selection & Planning
            </h2>
            <p class="card-description">
              Manage and report site selection and planning details.
            </p>
          </div>
          <div class="card-content">
            <button class="btn btn-primary mb-4" id="add-site-report-trigger">
              <i class="fas fa-plus-circle mr-2"></i> Report Site Selection
            </button>

            <div class="input-with-icon mt-6 mb-4">
              <input
                type="text"
                id="site-search-input"
                placeholder="Search by site or investigator..." />
              <i class="fas fa-search"></i>
            </div>

            <div class="mt-6">
              <h3 class="font-semibold mb-2">Submitted Reports</h3>
              <div class="border rounded-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead>
                    <tr>
                      <th>Site</th>
                      <th>Investigator</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody
                    id="site-reports-tbody"
                    class="bg-white divide-y divide-gray-200">
                    <tr>
                      <td
                        colspan="3"
                        class="text-gray-500 italic text-center p-4"
                        id="no-site-reports-message">
                        No site reports yet or no matches found.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- CRA Tab Content -->
        <div id="cra" class="tab-content card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-clipboard-check mr-2"></i> Data Review &
              Compliance Checks
            </h2>
            <p class="card-description">
              Upload summaries of data integrity or safety issues observed and
              categorize them.
            </p>
          </div>
          <div class="card-content">
            <div class="form-group">
              <textarea
                id="cra-summary-textarea"
                placeholder="Summarize any data integrity or safety issues..."
                rows="5"></textarea>
            </div>
            <div class="form-group">
              <select id="cra-category-select">
                <option value="general">General</option>
                <option value="data-integrity">Data Integrity</option>
                <option value="patient-safety">Patient Safety</option>
                <option value="protocol-deviation">Protocol Deviation</option>
              </select>
            </div>
            <button class="btn btn-primary w-full" id="submit-cra-summary">
              <i class="fas fa-paper-plane mr-2"></i> Submit Summary
            </button>

            <div class="mt-6 space-y-3">
              <h3 class="font-semibold mb-2">Submitted Summaries</h3>
              <div id="compliance-checks-list" class="border rounded-md">
                <p
                  class="text-gray-500 italic p-4"
                  id="no-cra-summaries-message">
                  No summaries submitted yet.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Regulatory Tab Content -->
        <div id="regulatory" class="tab-content card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-gavel mr-2"></i> Regulatory Affairs Dashboard
            </h2>
            <p class="card-description">
              Manage regulatory documents, track compliance status, and oversee
              key milestones.
            </p>
          </div>
          <div class="card-content">
            <!-- Regulatory Admin Access Gate (inside Regulatory tab) -->
            <div
              id="regulatory-admin-gate"
              class="card mb-4"
              style="display: none">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-lock mr-2"></i> Admin Access Required
                </h3>
                <p class="card-description">
                  Enter the password to manage regulatory compliance.
                </p>
              </div>
              <div class="card-content">
                <div class="form-group">
                  <input
                    type="password"
                    id="regulatory-admin-code"
                    placeholder="Enter Admin Password" />
                </div>
                <button
                  class="btn btn-primary w-full"
                  id="unlock-regulatory-panel">
                  <i class="fas fa-unlock mr-2"></i> Unlock Panel
                </button>
              </div>
            </div>

            <!-- Regulatory Dashboard Content (Hidden by default) -->
            <div id="regulatory-dashboard-content" style="display: none">
              <!-- Compliance Status Section -->
              <div>
                <h3 class="font-semibold text-lg mb-3 flex items-center">
                  <i class="fas fa-calendar-check mr-2"></i> Compliance Status
                </h3>
                <div class="flex items-center space-x-2 mb-4">
                  <p class="font-medium">Current Status:</p>
                  <span
                    id="current-compliance-status"
                    class="status-badge status-gray"
                    >N/A</span
                  >
                </div>

                <div class="form-group">
                  <select id="compliance-status-select">
                    <option value="">Select compliance result</option>
                    <option value="approved">Approved</option>
                    <option value="revision-needed">Revision Needed</option>
                    <option value="rejected">Rejected</option>
                    <option value="needs-review">Needs Review</option>
                  </select>
                </div>
                <div class="flex space-x-2 mt-3">
                  <button
                    class="btn btn-primary flex-1"
                    id="save-compliance-status">
                    <i class="fas fa-save mr-2"></i> Save Status
                  </button>
                  <button class="btn btn-outline" id="lock-regulatory-panel">
                    <i class="fas fa-lock mr-2"></i> Lock Panel
                  </button>
                </div>
              </div>

              <hr class="my-6" />

              <!-- Document Management Section -->
              <div>
                <h3 class="font-semibold text-lg mb-3 flex items-center">
                  <i class="fas fa-file-upload mr-2"></i> Document Management
                </h3>
                <div class="input-group">
                  <div>
                    <label for="doc-name">Document Name</label>
                    <input
                      type="text"
                      id="doc-name"
                      placeholder="e.g., IRB Approval Letter" />
                  </div>
                  <div>
                    <label for="doc-link">Document Link (Optional)</label>
                    <input
                      type="text"
                      id="doc-link"
                      placeholder="e.g., https://docs.example.com/irb_letter" />
                  </div>
                  <button class="btn btn-primary" id="add-document">
                    <i class="fas fa-upload mr-2"></i> Add Document
                  </button>
                </div>

                <div class="border rounded-md mt-4 overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                      <tr>
                        <th>Document Name</th>
                        <th>Link</th>
                        <th>Uploaded At</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody
                      id="regulatory-documents-tbody"
                      class="bg-white divide-y divide-gray-200">
                      <tr id="no-documents-message">
                        <td
                          colspan="4"
                          class="text-gray-500 italic text-center p-4">
                          No documents added yet.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <hr class="my-6" />

              <!-- Regulatory Milestones Section -->
              <div>
                <h3 class="font-semibold text-lg mb-3 flex items-center">
                  <i class="fas fa-flag-checkered mr-2"></i> Regulatory
                  Milestones
                </h3>
                <div class="input-group">
                  <div>
                    <label for="milestone-desc">Milestone Description</label>
                    <input
                      type="text"
                      id="milestone-desc"
                      placeholder="e.g., Submit IND Application" />
                  </div>
                  <div>
                    <label for="milestone-date">Due Date</label>
                    <input type="date" id="milestone-date" />
                  </div>
                  <button class="btn btn-primary" id="add-milestone">
                    <i class="fas fa-plus-circle mr-2"></i> Add Milestone
                  </button>
                </div>

                <div class="border rounded-md mt-4 overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                      <tr>
                        <th>Description</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody
                      id="regulatory-milestones-tbody"
                      class="bg-white divide-y divide-gray-200">
                      <tr id="no-milestones-message">
                        <td
                          colspan="4"
                          class="text-gray-500 italic text-center p-4">
                          No milestones added yet.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <hr class="my-6" />

              <!-- Compliance Audit Log Section -->
              <div>
                <h3 class="font-semibold text-lg mb-3 flex items-center">
                  <i class="fas fa-history mr-2"></i> Compliance Audit Log
                </h3>
                <div class="audit-log-container" id="audit-log-container">
                  <p class="text-gray-500 italic" id="no-audit-entries-message">
                    No audit entries yet.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <!-- Site Report Modal -->
    <div
      id="siteReportModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="siteReportModalTitle">
      <div class="modal-content">
        <button
          class="modal-close-btn"
          data-modal="siteReportModal"
          aria-label="Close">
          &times;
        </button>
        <div class="modal-header">
          <h2 class="modal-title" id="siteReportModalTitle">
            Add New Site Report
          </h2>
          <p class="modal-description">
            Enter site selection and planning details.
          </p>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="site-name-input">Site Name</label>
            <input type="text" id="site-name-input" placeholder="Site Name" />
          </div>
          <div class="form-group">
            <label for="investigator-input">Principal Investigator</label>
            <input
              type="text"
              id="investigator-input"
              placeholder="Principal Investigator" />
          </div>
          <div class="form-group">
            <label for="notes-textarea">Notes on planning</label>
            <textarea
              id="notes-textarea"
              placeholder="Notes on planning"
              rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="save-site-report-button">
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- View Site Report Details Modal -->
    <div
      id="viewSiteReportModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="view-report-description">
      <div class="modal-content">
        <button
          class="modal-close-btn"
          data-modal="viewSiteReportModal"
          aria-label="Close">
          &times;
        </button>
        <div class="modal-header">
          <h2 class="modal-title">Site Report Details</h2>
          <p class="modal-description" id="view-report-description"></p>
        </div>
        <div class="modal-body space-y-2">
          <p><strong>Site Name:</strong> <span id="view-site-name"></span></p>
          <p>
            <strong>Principal Investigator:</strong>
            <span id="view-investigator"></span>
          </p>
          <p><strong>Notes:</strong> <span id="view-notes"></span></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" data-modal="viewSiteReportModal">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Custom Toast Notification -->
    <div id="custom-toast"></div>

    <script>
      // --- Global State ---
      let siteReports = [];
      let complianceChecks = [];
      let adminUnlockedRegulatory = false;
      let complianceStatus = "";
      let regulatoryAuditLog = [];
      let regulatoryDocuments = [];
      let regulatoryMilestones = [];

      // --- DOM Elements ---
      const loginContainer = document.getElementById("login-container");
      const appContainer = document.getElementById("app-container");
      const adminCodeInput = document.getElementById("admin-code-input");
      const loginButton = document.getElementById("login-button");
      const customToast = document.getElementById("custom-toast");

      // Tabs
      const tabButtons = document.querySelectorAll(".tab-buttons button");
      const tabContents = document.querySelectorAll(".tab-content");

      // Clinical Manager Tab Elements
      const addSiteReportTrigger = document.getElementById(
        "add-site-report-trigger"
      );
      const siteReportsTbody = document.getElementById("site-reports-tbody");
      const noSiteReportsMessage = document.getElementById(
        "no-site-reports-message"
      );
      const siteSearchInput = document.getElementById("site-search-input");

      // Site Report Modal Elements
      const siteReportModal = document.getElementById("siteReportModal");
      const siteReportModalTitle = document.getElementById(
        "siteReportModalTitle"
      );
      const siteNameInput = document.getElementById("site-name-input");
      const investigatorInput = document.getElementById("investigator-input");
      const notesTextarea = document.getElementById("notes-textarea");
      const saveSiteReportButton = document.getElementById(
        "save-site-report-button"
      );
      let editingSiteReportId = null;

      // View Site Report Modal Elements
      const viewSiteReportModal = document.getElementById(
        "viewSiteReportModal"
      );
      const viewReportDescription = document.getElementById(
        "view-report-description"
      );
      const viewSiteName = document.getElementById("view-site-name");
      const viewInvestigator = document.getElementById("view-investigator");
      const viewNotes = document.getElementById("view-notes");

      // CRA Tab Elements
      const craSummaryTextarea = document.getElementById(
        "cra-summary-textarea"
      );
      const craCategorySelect = document.getElementById("cra-category-select");
      const submitCraSummaryButton =
        document.getElementById("submit-cra-summary");
      const complianceChecksList = document.getElementById(
        "compliance-checks-list"
      );
      const noCraSummariesMessage = document.getElementById(
        "no-cra-summaries-message"
      );
      let editingCraSummaryId = null;

      // Regulatory Tab Elements
      const regulatoryAdminGate = document.getElementById(
        "regulatory-admin-gate"
      );
      const regulatoryDashboardContent = document.getElementById(
        "regulatory-dashboard-content"
      );
      const regulatoryAdminCodeInput = document.getElementById(
        "regulatory-admin-code"
      );
      const unlockRegulatoryPanelButton = document.getElementById(
        "unlock-regulatory-panel"
      );
      const lockRegulatoryPanelButton = document.getElementById(
        "lock-regulatory-panel"
      );

      const currentComplianceStatusSpan = document.getElementById(
        "current-compliance-status"
      );
      const complianceStatusSelect = document.getElementById(
        "compliance-status-select"
      );
      const saveComplianceStatusButton = document.getElementById(
        "save-compliance-status"
      );

      const docNameInput = document.getElementById("doc-name");
      const docLinkInput = document.getElementById("doc-link");
      const addDocumentButton = document.getElementById("add-document");
      const regulatoryDocumentsTbody = document.getElementById(
        "regulatory-documents-tbody"
      );
      const noDocumentsMessage = document.getElementById(
        "no-documents-message"
      );

      const milestoneDescInput = document.getElementById("milestone-desc");
      const milestoneDateInput = document.getElementById("milestone-date");
      const addMilestoneButton = document.getElementById("add-milestone");
      const regulatoryMilestonesTbody = document.getElementById(
        "regulatory-milestones-tbody"
      );
      const noMilestonesMessage = document.getElementById(
        "no-milestones-message"
      );

      const auditLogContainer = document.getElementById("audit-log-container");
      const noAuditEntriesMessage = document.getElementById(
        "no-audit-entries-message"
      );

      // --- API Fetch Functions ---
      async function fetchSiteReports() {
        try {
          const response = await fetch("/api/oversight/site-reports");
          siteReports = await response.json();
          renderSiteReports();
        } catch (error) {
          console.error("Error fetching site reports:", error);
        }
      }

      async function fetchComplianceChecks() {
        try {
          const response = await fetch("/api/oversight/compliance-checks");
          complianceChecks = await response.json();
          renderComplianceChecks();
        } catch (error) {
          console.error("Error fetching compliance checks:", error);
        }
      }

      async function fetchRegulatoryDocuments() {
        try {
          const response = await fetch("/api/oversight/regulatory-documents");
          regulatoryDocuments = await response.json();
          renderRegulatoryDocuments();
        } catch (error) {
          console.error("Error fetching regulatory documents:", error);
        }
      }

      async function fetchRegulatoryMilestones() {
        try {
          const response = await fetch("/api/oversight/regulatory-milestones");
          regulatoryMilestones = await response.json();
          renderRegulatoryMilestones();
        } catch (error) {
          console.error("Error fetching regulatory milestones:", error);
        }
      }

      async function fetchRegulatoryAuditLogs() {
        try {
          const response = await fetch("/api/oversight/regulatory-audit-logs");
          regulatoryAuditLog = await response.json();
          renderAuditLog();
        } catch (error) {
          console.error("Error fetching regulatory audit logs:", error);
        }
      }

      // --- Helper Functions ---
      function getToken() {
        return localStorage.getItem('token');
      }

      function getUserRole() {
        return localStorage.getItem('userRole');
      }

      function showToast(message, type = "success") {
        customToast.textContent = message;
        customToast.style.opacity = "1";
        customToast.style.visibility = "visible";
        customToast.style.backgroundColor =
          {
            success: "#22c55e",
            error: "#ef4444",
            warning: "#f59e0b",
            info: "#3b82f6",
          }[type] || "#333";

        setTimeout(() => {
          customToast.style.opacity = "0";
          customToast.style.visibility = "hidden";
        }, 3000);
      }

      function openModal(modalElement) {
        modalElement.style.display = "flex";
      }

      function closeModal(modalElement) {
        modalElement.style.display = "none";
      }

      // Function to handle tab switching
      function handleTabClick(event) {
        tabContents.forEach((content) => content.classList.remove("active"));
        tabButtons.forEach((btn) => btn.classList.remove("active"));
        const targetTabId = event.currentTarget.dataset.tab;
        document.getElementById(targetTabId).classList.add("active");
        event.currentTarget.classList.add("active");
        if (targetTabId === "regulatory") {
          renderRegulatoryDashboard();
        } else if (targetTabId === "clinical") {
          fetchSiteReports();
        } else if (targetTabId === "cra") {
          fetchComplianceChecks();
        }
      }

      // --- Render Functions ---

      // Clinical Manager Render
      function renderSiteReports() {
        siteReportsTbody.innerHTML = "";
        const filtered = siteReports.filter(
          (report) =>
            report.siteName
              .toLowerCase()
              .includes(siteSearchInput.value.toLowerCase()) ||
            report.investigator
              .toLowerCase()
              .includes(siteSearchInput.value.toLowerCase())
        );

        if (filtered.length === 0) {
          siteReportsTbody.appendChild(noSiteReportsMessage);
          noSiteReportsMessage.style.display = "table-cell";
        } else {
          noSiteReportsMessage.style.display = "none";
          filtered.forEach((report) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                      <td class="whitespace-nowrap">${report.siteName}</td>
                      <td class="whitespace-nowrap">${report.investigator}</td>
                      <td class="whitespace-nowrap actions-cell">
                          <button class="btn btn-outline btn-sm" data-action="view" data-id="${report.id}" title="View">
                              <i class="fas fa-eye"></i>
                          </button>
                          <button class="btn btn-outline btn-sm" data-action="edit" data-id="${report.id}" title="Edit">
                              <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-destructive btn-sm" data-action="delete" data-id="${report.id}" title="Delete">
                              <i class="fas fa-trash-alt"></i>
                          </button>
                      </td>
                  `;
            siteReportsTbody.appendChild(row);
          });
        }
      }

      // CRA Render
      function renderComplianceChecks() {
        complianceChecksList.innerHTML = "";
        if (complianceChecks.length === 0) {
          complianceChecksList.appendChild(noCraSummariesMessage);
          noCraSummariesMessage.style.display = "block";
        } else {
          noCraSummariesMessage.style.display = "none";
          complianceChecks.forEach((item) => {
            const div = document.createElement("div");
            div.className =
              "border p-3 rounded-md text-sm bg-gray-50 flex justify-between items-start";
            div.innerHTML = `
                      <div>
                          <p><strong>Category:</strong> ${capitalize(
                            item.category.replace(/-/g, " ")
                          )}</p>
                          <p>${item.text}</p>
                      </div>
                      <div class="actions-cell">
                          <button class="btn btn-outline btn-sm" data-action="edit" data-id="${
                            item.id
                          }" title="Edit">
                              <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn btn-destructive btn-sm" data-action="delete" data-id="${
                            item.id
                          }" title="Delete">
                              <i class="fas fa-trash-alt"></i>
                          </button>
                      </div>
                  `;
            complianceChecksList.appendChild(div);
          });
        }
      }

      // Regulatory Render
      function renderRegulatoryDashboard() {
        if (adminUnlockedRegulatory) {
          regulatoryAdminGate.style.display = "none";
          regulatoryDashboardContent.style.display = "block";
          updateComplianceStatusDisplay();
          renderRegulatoryDocuments();
          renderRegulatoryMilestones();
          renderAuditLog();
        } else {
          regulatoryAdminGate.style.display = "block";
          regulatoryDashboardContent.style.display = "none";
        }
      }

      function updateComplianceStatusDisplay() {
        currentComplianceStatusSpan.textContent = complianceStatus
          ? complianceStatus.replace(/-/g, " ").toUpperCase()
          : "N/A";
        currentComplianceStatusSpan.className = "status-badge";
        if (complianceStatus === "approved")
          currentComplianceStatusSpan.classList.add("status-green");
        else if (complianceStatus === "revision-needed")
          currentComplianceStatusSpan.classList.add("status-yellow");
        else if (complianceStatus === "rejected")
          currentComplianceStatusSpan.classList.add("status-red");
        else if (complianceStatus === "needs-review")
          currentComplianceStatusSpan.classList.add("status-blue");
        else currentComplianceStatusSpan.classList.add("status-gray");

        complianceStatusSelect.value = complianceStatus;
      }

      function renderRegulatoryDocuments() {
        regulatoryDocumentsTbody.innerHTML = "";
        if (regulatoryDocuments.length === 0) {
          regulatoryDocumentsTbody.appendChild(noDocumentsMessage);
          noDocumentsMessage.style.display = "table-row";
        } else {
          noDocumentsMessage.style.display = "none";
          regulatoryDocuments.forEach((doc) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                      <td class="whitespace-nowrap">${doc.name}</td>
                      <td class="whitespace-nowrap">
                          ${
                            doc.link
                              ? `<a href="${doc.link}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline flex items-center"><i class="fas fa-external-link-alt mr-1"></i> View</a>`
                              : `<span class="text-gray-400 italic">N/A</span>`
                          }
                      </td>
                      <td class="whitespace-nowrap">${doc.uploadedAt}</td>
                      <td class="whitespace-nowrap actions-cell">
                          <button class="btn btn-destructive btn-sm" data-action="delete-doc" data-id="${
                            doc.id
                          }" title="Delete Document">
                              <i class="fas fa-trash-alt"></i>
                          </button>
                      </td>
                  `;
            regulatoryDocumentsTbody.appendChild(row);
          });
        }
      }

      function renderRegulatoryMilestones() {
        regulatoryMilestonesTbody.innerHTML = "";
        if (regulatoryMilestones.length === 0) {
          regulatoryMilestonesTbody.appendChild(noMilestonesMessage);
          noMilestonesMessage.style.display = "table-row";
        } else {
          noMilestonesMessage.style.display = "none";
          regulatoryMilestones.forEach((milestone) => {
            const row = document.createElement("tr");
            const statusClass = milestone.completed
              ? "status-green"
              : "status-orange";
            const statusText = milestone.completed ? "Completed" : "Pending";
            const descriptionClass = milestone.completed
              ? "line-through text-gray-500"
              : "";

            row.innerHTML = `
                      <td class="${descriptionClass}">${
              milestone.description
            }</td>
                      <td class="whitespace-nowrap">${milestone.dueDate}</td>
                      <td class="whitespace-nowrap">
                          <span class="status-badge ${statusClass}">${statusText}</span>
                      </td>
                      <td class="whitespace-nowrap actions-cell">
                          <button class="btn btn-outline btn-sm" data-action="toggle-milestone" data-id="${
                            milestone.id
                          }" title="${
              milestone.completed ? "Reopen" : "Complete"
            }">
                              ${milestone.completed ? "Reopen" : "Complete"}
                          </button>
                          <button class="btn btn-destructive btn-sm" data-action="delete-milestone" data-id="${
                            milestone.id
                          }" title="Delete Milestone">
                              <i class="fas fa-trash-alt"></i>
                          </button>
                      </td>
                  `;
            regulatoryMilestonesTbody.appendChild(row);
          });
        }
      }

      function renderAuditLog() {
        auditLogContainer.innerHTML = "";
        if (regulatoryAuditLog.length === 0) {
          auditLogContainer.appendChild(noAuditEntriesMessage);
          noAuditEntriesMessage.style.display = "block";
        } else {
          noAuditEntriesMessage.style.display = "none";
          regulatoryAuditLog
            .slice()
            .reverse()
            .forEach((log) => {
              const div = document.createElement("div");
              div.className = "audit-log-entry";
              div.innerHTML = `
                      <span class="timestamp">[${log.timestamp}]</span>
                      <span class="type">${log.type.replace(/_/g, " ")}:</span>
                      ${log.notes}
                  `;
              auditLogContainer.appendChild(div);
            });
        }
      }

      // --- Utility for Capitalization ---
      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      // --- Event Handlers ---

      // Main Admin Login
      loginButton.addEventListener("click", () => {
        if (adminCodeInput.value === "admin505") {
          adminAccess = true;
          loginContainer.classList.add("hidden");
          appContainer.classList.remove("hidden");
          handleTabClick({
            currentTarget: document.getElementById("tab-clinical"),
          });
          fetchSiteReports();
          fetchComplianceChecks();
          fetchRegulatoryDocuments();
          fetchRegulatoryMilestones();
          fetchRegulatoryAuditLogs();
          showToast("Welcome to Clinical Study Oversight!", "success");
        } else {
          showToast("Access Denied. Incorrect code.", "error");
        }
        adminCodeInput.value = "";
      });

      // Tab Switching
      tabButtons.forEach((button) => {
        button.addEventListener("click", handleTabClick);
      });

      // Clinical Manager Tab Handlers
      addSiteReportTrigger.addEventListener("click", () => {
        editingSiteReportId = null;
        siteReportModalTitle.textContent = "Add New Site Report";
        siteNameInput.value = "";
        investigatorInput.value = "";
        notesTextarea.value = "";
        openModal(siteReportModal);
      });

      saveSiteReportButton.addEventListener("click", async () => {
        const siteName = siteNameInput.value.trim();
        const investigator = investigatorInput.value.trim();
        const notes = notesTextarea.value.trim();

        if (!siteName || !investigator) {
          showToast(
            "Site Name and Principal Investigator are required.",
            "error"
          );
          return;
        }

        if (editingSiteReportId) {
          try {
            const response = await fetch(
              `/api/oversight/site-reports/${editingSiteReportId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ siteName, investigator, notes }),
              }
            );
            if (response.ok) {
              showToast("Site report updated successfully!", "success");
              fetchSiteReports(); // Re-fetch to update UI
            } else {
              showToast("Failed to update site report.", "error");
            }
          } catch (error) {
            console.error("Error updating site report:", error);
            showToast("Error updating site report.", "error");
          }
        } else {
          try {
            const response = await fetch("/api/oversight/site-reports", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ siteName, investigator, notes }),
            });
            if (response.ok) {
              showToast("Site report submitted successfully!", "success");
              fetchSiteReports(); // Re-fetch to update UI
            } else {
              showToast("Failed to submit site report.", "error");
            }
          } catch (error) {
            console.error("Error submitting site report:", error);
            showToast("Error submitting site report.", "error");
          }
        }
        closeModal(siteReportModal);
      });

      siteReportsTbody.addEventListener("click", async (event) => {
        const target = event.target.closest("button");
        if (!target) return;

        const id = parseInt(target.dataset.id);
        const action = target.dataset.action;
        const report = siteReports.find((r) => r.id === id);

        if (!report) return;

        if (action === "view") {
          viewSiteName.textContent = report.siteName;
          viewInvestigator.textContent = report.investigator;
          viewNotes.textContent = report.notes;
          viewReportDescription.textContent = `Detailed information for ${report.siteName}`;
          openModal(viewSiteReportModal);
        } else if (action === "edit") {
          editingSiteReportId = id;
          siteReportModalTitle.textContent = "Edit Site Report";
          siteNameInput.value = report.siteName;
          investigatorInput.value = report.investigator;
          notesTextarea.value = report.notes;
          openModal(siteReportModal);
        } else if (action === "delete") {
          if (
            confirm(
              `Are you sure you want to delete the report for ${report.siteName}?`
            )
          ) {
            try {
              const response = await fetch(
                `/api/oversight/site-reports/${id}`,
                {
                  method: "DELETE",
                }
              );
              if (response.ok) {
                showToast("Site report deleted successfully!", "info");
                fetchSiteReports(); // Re-fetch to update UI
              } else {
                showToast("Failed to delete site report.", "error");
              }
            } catch (error) {
              console.error("Error deleting site report:", error);
              showToast("Error deleting site report.", "error");
            }
          }
        }
      });

      siteSearchInput.addEventListener("input", renderSiteReports);

      // CRA Tab Handlers
      submitCraSummaryButton.addEventListener("click", async () => {
        const summaryText = craSummaryTextarea.value.trim();
        const category = craCategorySelect.value;

        if (!summaryText) {
          showToast("Summary cannot be empty.", "error");
          return;
        }

        if (editingCraSummaryId) {
          try {
            const response = await fetch(
              `/api/oversight/compliance-checks/${editingCraSummaryId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ text: summaryText, category: category }),
              }
            );
            if (response.ok) {
              showToast("Compliance summary updated.", "success");
              fetchComplianceChecks();
              editingCraSummaryId = null;
              submitCraSummaryButton.innerHTML =
                '<i class="fas fa-paper-plane mr-2"></i> Submit Summary';
            } else {
              showToast("Failed to update compliance summary.", "error");
            }
          } catch (error) {
            console.error("Error updating compliance summary:", error);
            showToast("Error updating compliance summary.", "error");
          }
        } else {
          try {
            const response = await fetch("/api/oversight/compliance-checks", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ text: summaryText, category: category }),
            });
            if (response.ok) {
              showToast("Data review summary submitted.", "success");
              fetchComplianceChecks();
            } else {
              showToast("Failed to submit data review summary.", "error");
            }
          } catch (error) {
            console.error("Error submitting data review summary:", error);
            showToast("Error submitting data review summary.", "error");
          }
        }
        craSummaryTextarea.value = "";
        craCategorySelect.value = "general";
      });

      complianceChecksList.addEventListener("click", async (event) => {
        const target = event.target.closest("button");
        if (!target) return;

        const id = parseInt(target.dataset.id);
        const action = target.dataset.action;
        const check = complianceChecks.find((c) => c.id === id);

        if (!check) return;

        if (action === "edit") {
          editingCraSummaryId = id;
          craSummaryTextarea.value = check.text;
          craCategorySelect.value = check.category;
          submitCraSummaryButton.innerHTML =
            '<i class="fas fa-save mr-2"></i> Update Summary';
        } else if (action === "delete") {
          if (confirm(`Are you sure you want to delete this summary?`)) {
            try {
              const response = await fetch(
                `/api/oversight/compliance-checks/${id}`,
                {
                  method: "DELETE",
                }
              );
              if (response.ok) {
                showToast("Compliance summary deleted.", "info");
                fetchComplianceChecks();
              } else {
                showToast("Failed to delete compliance summary.", "error");
              }
            } catch (error) {
              console.error("Error deleting compliance summary:", error);
              showToast("Error deleting compliance summary.", "error");
            }
          }
        }
      });

      // Regulatory Tab Handlers
      unlockRegulatoryPanelButton.addEventListener("click", () => {
        if (regulatoryAdminCodeInput.value === "505") {
          setAdminUnlockedRegulatory(true);
          showToast("Admin Panel Unlocked!", "success");
        } else {
          showToast("Access denied. Incorrect password.", "error");
        }
        regulatoryAdminCodeInput.value = "";
        renderRegulatoryDashboard();
      });

      lockRegulatoryPanelButton.addEventListener("click", () => {
        setAdminUnlockedRegulatory(false);
        showToast("Admin Panel Locked.", "info");
        renderRegulatoryDashboard();
      });

      saveComplianceStatusButton.addEventListener("click", async () => {
        const status = complianceStatusSelect.value;
        if (status) {
          try {
            const response = await fetch("/api/oversight/regulatory-milestones", { // Using regulatory-milestones as a placeholder for status update
              method: "POST", // Assuming a POST to update status or a PUT to a specific status endpoint
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ status: status }),
            });
            if (response.ok) {
              const newLogEntry = {
                type: "status_change",
                status: status,
                timestamp: new Date().toLocaleString(),
                notes: `Compliance status updated to: ${status.replace(
                  /-/g,
                  " "
                )}.`,
              };
              // Assuming audit logs are also managed via API
              await fetch("/api/oversight/regulatory-audit-logs", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(newLogEntry),
              });
              showToast(
                `Compliance marked as: ${status.replace(/-/g, " ")}`,
                "success"
              );
              updateComplianceStatusDisplay();
              fetchRegulatoryAuditLogs(); // Re-fetch audit logs
            } else {
              showToast("Failed to update compliance status.", "error");
            }
          } catch (error) {
            console.error("Error updating compliance status:", error);
            showToast("Error updating compliance status.", "error");
          }
        } else {
          showToast("Please select a compliance status.", "warning");
        }
      });

      addDocumentButton.addEventListener("click", async () => {
        const name = docNameInput.value.trim();
        const link = docLinkInput.value.trim();
        if (name) {
          try {
            const response = await fetch("/api/oversight/regulatory-documents", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ name, link, uploadedAt: new Date().toLocaleString() }),
            });
            if (response.ok) {
              const newLogEntry = {
                type: "document_added",
                timestamp: new Date().toLocaleString(),
                notes: `Document added: "${name}".`,
              };
              await fetch("/api/oversight/regulatory-audit-logs", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(newLogEntry),
              });
              showToast("Document added successfully!", "success");
              docNameInput.value = "";
              docLinkInput.value = "";
              fetchRegulatoryDocuments();
              fetchRegulatoryAuditLogs();
            } else {
              showToast("Failed to add document.", "error");
            }
          } catch (error) {
            console.error("Error adding document:", error);
            showToast("Error adding document.", "error");
          }
        } else {
          showToast("Document name is required.", "error");
        }
      });

      regulatoryDocumentsTbody.addEventListener("click", async (event) => {
        const target = event.target.closest("button");
        if (!target) return;

        const id = parseInt(target.dataset.id);
        const action = target.dataset.action;
        const deletedDoc = regulatoryDocuments.find((doc) => doc.id === id);

        if (action === "delete-doc") {
          if (
            confirm(
              `Are you sure you want to delete document "${
                deletedDoc?.name || "Unknown Document"
              }"?`
            )
          ) {
            try {
              const response = await fetch(
                `/api/oversight/regulatory-documents/${id}`,
                {
                  method: "DELETE",
                }
              );
              if (response.ok) {
                const newLogEntry = {
                  type: "document_deleted",
                  timestamp: new Date().toLocaleString(),
                  notes: `Document deleted: "${
                    deletedDoc?.name || "Unknown Document"
                  }".`,
                };
                await fetch("/api/oversight/regulatory-audit-logs", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(newLogEntry),
                });
                showToast("Document deleted successfully!", "info");
                fetchRegulatoryDocuments();
                fetchRegulatoryAuditLogs();
              } else {
                showToast("Failed to delete document.", "error");
              }
            } catch (error) {
              console.error("Error deleting document:", error);
              showToast("Error deleting document.", "error");
            }
          }
        }
      });

      addMilestoneButton.addEventListener("click", async () => {
        const description = milestoneDescInput.value.trim();
        const dueDate = milestoneDateInput.value.trim();
        if (description && dueDate) {
          const newMilestone = {
            description: description,
            dueDate: dueDate,
            completed: false,
          };
          try {
            const response = await fetch("/api/oversight/regulatory-milestones", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(newMilestone),
            });
            if (response.ok) {
              const newLogEntry = {
                type: "milestone_added",
                timestamp: new Date().toLocaleString(),
                notes: `Milestone added: "${newMilestone.description}" due by ${newMilestone.dueDate}.`,
              };
              await fetch("/api/oversight/regulatory-audit-logs", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(newLogEntry),
              });
              showToast("Milestone added successfully!", "success");
              milestoneDescInput.value = "";
              milestoneDateInput.value = "";
              fetchRegulatoryMilestones();
              fetchRegulatoryAuditLogs();
            } else {
              showToast("Failed to add milestone.", "error");
            }
          } catch (error) {
            console.error("Error adding milestone:", error);
            showToast("Error adding milestone.", "error");
          }
        } else {
          showToast(
            "Milestone description and due date are required.",
            "error"
          );
        }
      });

      regulatoryMilestonesTbody.addEventListener("click", async (event) => {
        const target = event.target.closest("button");
        if (!target) return;

        const id = parseInt(target.dataset.id);
        const action = target.dataset.action;
        const toggledMilestone = regulatoryMilestones.find((m) => m.id === id);

        if (!toggledMilestone) return;

        if (action === "toggle-milestone") {
          try {
            const response = await fetch(
              `/api/oversight/regulatory-milestones/${id}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ completed: !toggledMilestone.completed }),
              }
            );
            if (response.ok) {
              const newLogEntry = {
                type: toggledMilestone.completed
                  ? "milestone_reopened"
                  : "milestone_completed",
                timestamp: new Date().toLocaleString(),
                notes: `Milestone "${toggledMilestone.description}" marked as ${
                  toggledMilestone.completed ? "reopened" : "completed"
                }.`,
              };
              await fetch("/api/oversight/regulatory-audit-logs", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(newLogEntry),
              });
              showToast(
                `Milestone "${toggledMilestone.description}" marked as ${
                  toggledMilestone.completed ? "reopened" : "completed"
                }.`,
                "info"
              );
              fetchRegulatoryMilestones();
              fetchRegulatoryAuditLogs();
            } else {
              showToast("Failed to update milestone.", "error");
            }
          } catch (error) {
            console.error("Error updating milestone:", error);
            showToast("Error updating milestone.", "error");
          }
        } else if (action === "delete-milestone") {
          if (
            confirm(
              `Are you sure you want to delete milestone "${toggledMilestone.description}"?`
            )
          ) {
            try {
              const response = await fetch(
                `/api/oversight/regulatory-milestones/${id}`,
                {
                  method: "DELETE",
                }
              );
              if (response.ok) {
                const newLogEntry = {
                  type: "milestone_deleted",
                  timestamp: new Date().toLocaleString(),
                  notes: `Milestone deleted: "${toggledMilestone.description}".`,
                };
                await fetch("/api/oversight/regulatory-audit-logs", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(newLogEntry),
                });
                showToast("Milestone deleted successfully!", "info");
                fetchRegulatoryMilestones();
                fetchRegulatoryAuditLogs();
              } else {
                showToast("Failed to delete milestone.", "error");
              }
            } catch (error) {
              console.error("Error deleting milestone:", error);
              showToast("Error deleting milestone.", "error");
            }
          }
        }
      });

      // --- Modal Close Buttons (General) ---
      document.querySelectorAll(".modal-close-btn").forEach((button) => {
        button.addEventListener("click", (event) => {
          const modalId = event.target.dataset.modal;
          closeModal(document.getElementById(modalId));
        });
      });

      // Close modal if clicking outside
      window.addEventListener("click", (event) => {
        if (event.target.classList.contains("modal")) {
          closeModal(event.target);
        }
      });

      // --- Initial Render on Load ---
      document.addEventListener("DOMContentLoaded", () => {
        // Check main admin access
        if (adminAccess) {
          loginContainer.classList.add("hidden");
          appContainer.classList.remove("hidden");
          // Call handleTabClick to set the initial active tab and render its content
          handleTabClick({
            currentTarget: document.getElementById("tab-clinical"),
          });
        } else {
          loginContainer.classList.remove("hidden");
          appContainer.classList.add("hidden");
        }

        // Initial render for all sections (these will be called again by handleTabClick for the active tab)
        fetchSiteReports();
        fetchComplianceChecks();
        fetchRegulatoryDocuments();
        fetchRegulatoryMilestones();
        fetchRegulatoryAuditLogs();
        renderRegulatoryDashboard(); // This will handle its
      });
    </script>
  </body>
</html>
